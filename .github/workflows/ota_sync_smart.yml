name: OTA Sync (smart)

on:
  schedule:
    - cron: "0 */3 * * *" # every 3 hours (UTC)
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: ota-sync-main
  cancel-in-progress: false

jobs:
  ota-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Light deps only for checking upstream
      - name: Install dependencies (light)
        run: |
          python -m pip install --upgrade pip
          pip install requests
          # policy_loader may need optional deps depending on your requirements files
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt || true; fi

      - name: Check upstream (fast)
        id: check
        run: |
          python -m backend.scripts.check_upstream \
            --targets sources/ota_targets.json \
            --state data/cache/_upstream_state.json

      - name: Show check outputs
        run: |
          echo "changed = ${{ steps.check.outputs.changed }}"
          echo "changed_keys = ${{ steps.check.outputs.changed_keys }}"

      # Heavy deps only when upstream changed
      - name: Install semantic engine (heavy)
        if: steps.check.outputs.changed == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install torch sentence-transformers

      - name: Run OTA sync (only if changed)
        if: steps.check.outputs.changed == 'true'
        env:
          OTA_TARGETS_PATH: sources/ota_targets.json
          CACHE_DIR: data/cache
          API_MODE: semantic
          MAX_CHANGES: "50"
        run: |
          python -m backend.scripts.ota_sync

      - name: Commit & push cache/state (only if changed)
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "consent-companion-bot"
          git config user.email "actions@users.noreply.github.com"

          git add data/cache

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "OTA sync: update rolling cache"

          # Avoid push rejection if main moved
          git fetch origin main
          git rebase origin/main
          git push origin HEAD:main
