name: OTA Sync (smart)

on:
  schedule:
    - cron: "0 */3 * * *" # every 3 hours (UTC)
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: ota-sync-main
  cancel-in-progress: false

jobs:
  ota-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Light deps first (fast upstream check)
      - name: Install dependencies (light)
        run: |
          python -m pip install --upgrade pip
          pip install requests

          # If your check_upstream imports project modules, keep these.
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt
          fi

      - name: Check upstream (fast)
        id: check
        env:
          OTA_TARGETS_PATH: sources/ota_targets.json
        run: |
          python -m backend.scripts.check_upstream \
            --targets sources/ota_targets.json \
            --state data/cache/_upstream_state.json

      - name: Show check outputs
        run: |
          echo "changed = ${{ steps.check.outputs.changed }}"
          echo "changed_keys = ${{ steps.check.outputs.changed_keys }}"

      # Heavy deps ONLY if something changed upstream
      - name: Install semantic engine (heavy, only if changed)
        if: steps.check.outputs.changed == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install torch sentence-transformers

      - name: Run OTA sync (only if upstream changed)
        if: steps.check.outputs.changed == 'true'
        env:
          OTA_TARGETS_PATH: sources/ota_targets.json
          CACHE_DIR: data/cache
          API_MODE: semantic
          MAX_CHANGES: "50"
        run: |
          python -m backend.scripts.ota_sync

      - name: Commit & push cache/state (only if upstream changed)
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "consent-companion-bot"
          git config user.email "actions@users.noreply.github.com"

          # Track cache + upstream state file
          git add data/cache

          # If nothing staged, stop here (no commit, no push)
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git status
          git commit -m "OTA sync: update rolling cache"

          # Rebase onto latest main to prevent push rejection
          git fetch origin main
          git rebase origin/main

          # Push current HEAD to main
          git push origin HEAD:main
